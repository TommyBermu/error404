{% extends 'base.html' %}
{% load static %}

{% block title %}
  {{ course.name }} - SAFE Academy
{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'administration/css/course_detail.css' %}" />
  <link rel="stylesheet" href="{% static 'administration/css/course_list.css' %}" />
  <link rel="stylesheet" href="{% static 'administration/css/module_form.css' %}" />
{% endblock %}

{% block content %}
  <div class="container">
    <div class="breadcrumb">
      <a href="{% url 'admin_panel' %}?tab=cursos">‚Üê Volver a Administraci√≥n</a>
    </div>
    <!-- header -->
    <div class="course-header">
      <div class="course-header-content">
        <h1>{{ course.name }}</h1>
        <span class="status-badge status-{{ course.status }}">{{ course.get_status_display }}</span>
      </div>
      <div class="course-header-actions">
        <a href="{% url 'course_update' course.pk %}" class="btn-secondary">Editar Metadatos</a>
        <form method="post" action="{% url 'course_delete' course.pk %}" style="display:inline;">
          {% csrf_token %}
          <button type="submit" class="btn-danger" onclick="return confirm('¬øEliminar {{ course.name }}?')">Eliminar Curso</button>
        </form>
      </div>
    </div>

    <!-- Course Info Card -->
    <div class="info-card">
      <div class="info-row">
        <div class="info-item">
          <span class="info-label">Descripci√≥n</span>
          <p class="info-value">{{ course.description|default:'Sin descripci√≥n' }}</p>
        </div>
      </div>
      <div class="info-row">
        <div class="info-item">
          <span class="info-label">Duraci√≥n</span>
          <span class="info-value">{{ course.duration_hours|default:'--' }} horas</span>
        </div>
        <div class="info-item">
          <span class="info-label">M√≥dulos</span>
          <span class="info-value">{{ modules.count }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Creado por</span>
          <span class="info-value">{{ course.created_by.username|default:'--' }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Fecha de creaci√≥n</span>
          <span class="info-value">{{ course.created_at|date:'d/m/Y' }}</span>
        </div>
      </div>
    </div>
  </div>

  <div class="container" style="display:flex;gap:10px;flex-wrap:wrap;">
    <!-- Modules -->
    <div style="flex:1 1 15%; min-width:320px;">
      <div class="section-header" style="align-items:center;">
        <h2 class="section-title">M√≥dulos</h2>
      </div>

      <div style="border:1px solid var(--safe-border); border-radius:12px; padding:14px; background:white;">
        <!-- Lista de m√≥dulos -->
        <div class="modules-list" id="modules-list">
          {% for module in modules %}
            <div class="module-card {% if selected_module and selected_module.pk == module.pk %}selected{% endif %}">
              <div class="module-header">
                <a href="{% url 'course_detail' course.pk %}?module={{ module.pk }}" class="module-card-link" aria-label="Ver m√≥dulo {{ module.name }}">
                  <div class="module-info">
                    <h3 class="module-title">{{ forloop.counter }}. {{ module.name }}</h3>
                    <p class="module-description">{{ module.contents.count }} contenido(s)</p>
                  </div>
                </a>
                <form method="post" action="{% url 'module_delete' module.pk %}" class="module-delete-form" onsubmit="return confirm('¬øEliminar {{ module.name }}?');">
                  {% csrf_token %}
                  <button type="submit" class="btn-danger module-delete-btn" aria-label="Eliminar m√≥dulo {{ module.name }}">X</button>
                </form>
              </div>
            </div>
          {% empty %}
            <div class="empty-state-small">No hay m√≥dulos a√∫n.</div>
          {% endfor %}
        </div>

        <!-- Inline module creation -->
        <form method="post" action="{% url 'module_create' course.pk %}" class="inline-module-form" style="margin-top:12px; display:flex; gap:8px; align-items:center;">
          {% csrf_token %}
          {{ module_form.name }} <!-- renderizado simple: widget ya trae placeholder/class -->
          <button type="submit" class="btn-primary" title="Agregar m√≥dulo" style="padding:10px 14px;border-radius:8px;background:var(--safe-gold);color:var(--safe-dark);">+</button>
        </form>
      </div>
    </div>

    <!-- Contents for selected module -->
    <div style="flex:1 1 50%; min-width:320px;">
      <div class="section-header">
        <h2 class="section-title">Contenidos del m√≥dulo</h2>
      </div>

      <div style="border:1px solid var(--safe-border); border-radius:12px; padding:14px; background:white;">
        {% if selected_module %}
          <div style="background:#f8fafb;padding:12px;border-radius:8px;margin-bottom:12px;">
            <div style="font-size:13px;color:var(--safe-ink2)">M√≥dulo seleccionado:</div>
            <div style="font-weight:700">{{ selected_module.name }}</div>
          </div>

          <!-- Lista de contenidos -->
          <div class="contents-list" style="margin-bottom:12px;">
            {% for content in selected_module.contents.all %}
              <div class="content-item" style="display:flex;align-items:center;gap:12px;padding:10px;border:1px solid #f1f5f9;border-radius:8px;margin-bottom:8px;">
                <span class="content-badge badge-{{ content.content_type }}" style="flex-shrink:0;">
                  {% if content.content_type == 'exam' %}
                    üìù Examen
                  {% elif content.content_type == 'assignment' %}
                    üìã Tarea
                  {% elif content.content_type == 'material' %}
                    üìÑ Material
                  {% else %}
                    Contenido
                  {% endif %}
                </span>
                <div style="flex:1;">
                  <div style="font-weight:600;">{{ content.title }}</div>
                  <div style="font-size:13px;color:var(--safe-ink2)">{{ content.description|truncatewords:18 }}</div>
                </div>
              </div>
            {% empty %}
              <div class="empty-state-small">No hay contenidos en este m√≥dulo.</div>
            {% endfor %}
          </div>

          <!-- Inline content creation form -->
          <form method="post" enctype="multipart/form-data" action="{% url 'content_create' selected_module.pk %}">
            {% csrf_token %}
            <div style="margin-bottom:8px;">
              <label style="display:block;font-weight:600;margin-bottom:6px;">Tipo de contenido</label>
              {{ content_form.content_type }}
            </div>

            <div style="margin-bottom:8px;">
              <label style="display:block;font-weight:600;margin-bottom:6px;">T√≠tulo</label>
              {{ content_form.title }}
            </div>

            <div style="margin-bottom:8px;">
              <label style="display:block;font-weight:600;margin-bottom:6px;">Descripci√≥n</label>
              {{ content_form.description }}
            </div>

            <!-- Material fields (file) -->
            <div style="margin-bottom:12px;">
              <label style="display:block;font-weight:600;margin-bottom:6px;">Archivo (si aplica)</label>
              {{ material_form.file }}
            </div>

            <div style="display:flex;gap:8px;justify-content:flex-end;">
              <a href="{% url 'course_detail' course.pk %}" class="btn-ghost">Cancelar</a>
              <button type="submit" class="btn-primary">Agregar contenido</button>
            </div>
          </form>
        {% else %}
          <div class="empty-state-small">Selecciona un m√≥dulo a la izquierda para ver y agregar contenidos.</div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Reuse delete modal (if not already present globally) -->
  <div id="delete-modal" class="confirm-overlay" style="display:none;">
    <div class="confirm-card">
      <div class="warning-icon">‚ö†Ô∏è</div>
      <h1 class="confirm-title">¬øEliminar?</h1>

      <div id="delete-entity-info" class="course-info">
        <h2 id="delete-entity-name" class="course-name"></h2>
        <div id="delete-entity-meta" class="course-meta"></div>
      </div>

      <div class="warning-box">
        <strong>‚ö†Ô∏è Esta acci√≥n no se puede deshacer</strong>
        <p>Al eliminar esto, se eliminar√°n todos los elementos asociados.</p>
      </div>

      <form id="delete-form" method="post" action="">
        {% csrf_token %}
        <div class="form-actions">
          <button type="button" id="delete-cancel" class="btn-secondary">‚Üê Cancelar</button>
          <button type="submit" class="btn-danger">üóëÔ∏è S√≠, eliminar</button>
        </div>
      </form>
    </div>
  </div>
{% endblock %}
